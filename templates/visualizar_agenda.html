<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Emerson Rodrigues</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class=" bg-color1"> 
    <main class="container pt-5 " > 
        <div class="d-flex">
            <div class="ms-auto">{{data.strftime('%d-%m-%Y')}}</div>
        </div>
        <ul id="lista" class="list-group">
            {% for atividade in agenda %}
                <li class="list-group-item shadow rounded p-3 position-relative mb-4 bg-white col-12" draggable="true" >
                    <span>{{atividade.nome}}</span>
                </li>
            {% endfor %}
        </ul>
        {{agenda|length}} Atividades registradas

    </main> 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
    <script> 
        const lista = document.getElementById('lista');
        let itemArrastado = null; 
        var saveIN = null;
        
        // 1️⃣ Quando começa a arrastar
        lista.addEventListener('dragstart', (e) => {
            if (e.target.tagName === 'LI') {
                itemArrastado = e.target;
                e.target.classList.add('dragging');
            } 
            if (saveIN !== null) {
                clearTimeout(saveIN);
                saveIN = null;
            } 
        });

        // 2️⃣ Quando solta o item (arraste terminou)
        lista.addEventListener('dragend', (e) => {
            if (e.target.tagName === 'LI') {
                e.target.classList.remove('dragging');
            }
            // salva se não houver movimento em 2s
            saveIN = setTimeout(() => {
                console.log('🔒 Salvando... nenhuma atividade após 2s');
                saveIN = null; // limpa a referência
            }, 2000);
        }); 
        function saveAlter(){
            
        }
        // 3️⃣ Enquanto arrasta sobre a lista
        lista.addEventListener('dragover', (e) => {
            e.preventDefault(); // Permite o drop
            const itemAbaixo = pegarElementoAbaixo(lista, e.clientY);
            if (itemAbaixo == null) {
                lista.appendChild(itemArrastado); // Solta no final
            } else {
                lista.insertBefore(itemArrastado, itemAbaixo); // Solta antes do item detectado
            }
        });

        // 👇 Função para detectar o item abaixo do mouse
        function pegarElementoAbaixo(container, mouseY) {
        const itens = [...container.querySelectorAll('li:not(.dragging)')];

        return itens.reduce((maisProximo, item) => {
            const box = item.getBoundingClientRect();
            const offset = mouseY - box.top - box.height / 2;
            if (offset < 0 && offset > maisProximo.offset) {
            return { offset: offset, elemento: item };
            } else {
            return maisProximo;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).elemento;
        }
  </script>
</body>
</html>